# OneRoster Gradebook サービス - 非機能要件定義書

## バージョン情報
- **文書バージョン**: 1.0.0
- **作成日**: 2025-10-30
- **ステータス**: Draft

## 1. パフォーマンス要件

### 1.1 レスポンスタイム

| 操作タイプ | 目標レスポンスタイム | 最大レスポンスタイム |
|-----------|-------------------|-------------------|
| GET（単一リソース） | 平均 200ms | 500ms |
| GET（コレクション、100件） | 平均 500ms | 1秒 |
| PUT（作成/更新） | 平均 500ms | 1秒 |
| DELETE（論理削除） | 平均 300ms | 800ms |
| OAuth 2.0トークン取得 | 平均 300ms | 1秒 |

### 1.2 スループット

| 指標 | 目標値 | 備考 |
|------|--------|------|
| 同時接続数 | 100接続 | 開発環境 |
| リクエスト処理能力 | 100リクエスト/秒 | 混合負荷 |
| データベース接続プールサイズ | 10-50接続 | 自動スケーリング |

### 1.3 スケーラビリティ

- **水平スケーリング**: 複数インスタンスでのロードバランシング対応
- **データベース**: Read Replicaによる読み取り分散
- **キャッシュ**: OAuth 2.0トークンのメモリキャッシュ

## 2. 可用性要件

### 2.1 稼働時間

| 環境 | 目標稼働率 | ダウンタイム（月間） |
|------|-----------|-------------------|
| 本番環境 | 99.5% | 最大3.6時間 |
| 開発環境 | 95% | メンテナンス時停止可 |

### 2.2 障害復旧

- **RPO（目標復旧時点）**: 1時間（データバックアップ）
- **RTO（目標復旧時間）**: 4時間（サービス復旧）
- **バックアップ**: 日次フルバックアップ、1時間ごとの増分バックアップ

### 2.3 ヘルスチェック

- **エンドポイント**: `GET /health`
- **チェック項目**:
  - APIサーバーの起動状態
  - データベース接続状態
  - OAuth 2.0プロバイダーへの到達性
- **レスポンス例**:
  ```json
  {
    "status": "healthy",
    "timestamp": "2024-10-30T10:30:00Z",
    "checks": {
      "database": "up",
      "oauth": "up"
    }
  }
  ```

## 3. セキュリティ要件

### 3.1 認証・認可

| 要件ID | 説明 | 実装方法 |
|--------|------|---------|
| **SEC-001** | OAuth 2.0 Client Credentials Grant | 標準ライブラリ使用 |
| **SEC-002** | スコープベース認可 | gradebook.readonly, gradebook.createput, gradebook.delete |
| **SEC-003** | トークン有効期限 | 1時間（設定可能） |
| **SEC-004** | トークンリフレッシュ | 期限切れ60秒前に自動更新 |

### 3.2 通信セキュリティ

| 要件ID | 説明 | 設定 |
|--------|------|------|
| **SEC-010** | TLS暗号化 | TLS 1.2以上必須 |
| **SEC-011** | 暗号スイート | AES256-GCM, CHACHA20-POLY1305推奨 |
| **SEC-012** | 証明書検証 | 本番環境で厳密な検証、開発環境では自己署名証明書許可 |
| **SEC-013** | HSTS | Strict-Transport-Securityヘッダー設定 |

### 3.3 データ保護

| 要件ID | 説明 | 実装 |
|--------|------|------|
| **SEC-020** | 入力検証 | すべてのユーザー入力をサニタイズ |
| **SEC-021** | SQLインジェクション対策 | パラメータ化クエリ/ORM使用 |
| **SEC-022** | XSS対策 | 出力エスケープ |
| **SEC-023** | CSRF対策 | APIではトークンベース認証のため不要 |
| **SEC-024** | レート制限 | 1分間100リクエスト/IPアドレス |

### 3.4 機密情報管理

- **環境変数**: client_secret、database_passwordは環境変数で管理
- **ログ**: トークン、パスワードをログ出力しない
- **アクセス制御**: データベースへの最小権限アクセス

## 4. 信頼性要件

### 4.1 エラーハンドリング

| エラータイプ | 処理方法 | レスポンス |
|------------|---------|----------|
| バリデーションエラー | 即座に400エラー返却 | OneRoster標準エラー形式 |
| データベースエラー | ロギング後500エラー | 詳細をログのみに記録 |
| 外部API障害 | リトライ3回後エラー返却 | タイムアウト5秒 |
| OAuth認証エラー | 401エラー、トークン再取得 | 標準OAuth 2.0エラー |

### 4.2 トランザクション管理

- **ACID特性**: データベーストランザクションで保証
- **ロールバック**: エラー発生時に自動ロールバック
- **分散トランザクション**: 現バージョンではサポート外（将来拡張）

### 4.3 冪等性

| HTTPメソッド | 冪等性 | 説明 |
|-------------|--------|------|
| GET | ○ | 同じリクエストで同じレスポンス |
| PUT | ○ | 同じsourcedIdで繰り返し実行可能 |
| DELETE | ○ | 既に削除済みでも204返却 |
| POST | × | 本実装では未使用 |

## 5. 運用性要件

### 5.1 ロギング

| ログレベル | 出力内容 | 出力先 |
|-----------|---------|--------|
| **DEBUG** | SQLクエリ、詳細な処理フロー | 開発環境のみ |
| **INFO** | HTTPリクエスト/レスポンス、トークン取得 | 標準出力 |
| **WARNING** | リトライ、遅延警告 | 標準出力 |
| **ERROR** | アプリケーションエラー | 標準エラー出力 |
| **CRITICAL** | サービス停止レベルのエラー | 標準エラー出力 + アラート |

**ログ形式**:
```json
{
  "timestamp": "2024-10-30T10:30:00.123Z",
  "level": "INFO",
  "service": "gradebook-api",
  "method": "GET",
  "path": "/categories",
  "status": 200,
  "duration_ms": 245,
  "user_agent": "Python/3.10 httpx/0.25.0"
}
```

### 5.2 監視

| 監視項目 | 収集間隔 | アラート閾値 |
|---------|---------|------------|
| CPU使用率 | 1分 | 80%超過 |
| メモリ使用率 | 1分 | 85%超過 |
| ディスクI/O | 1分 | 90%超過 |
| レスポンスタイム | リクエストごと | 1秒超過 |
| エラー率 | 5分 | 5%超過 |
| データベース接続数 | 1分 | プールサイズの90% |

### 5.3 メトリクス

- **APM（Application Performance Monitoring）**: New Relic、DataDog等の統合対応
- **カスタムメトリクス**:
  - API呼び出し回数（エンドポイント別）
  - OAuth 2.0トークン取得回数
  - データベースクエリ実行時間
  - キャッシュヒット率

### 5.4 デプロイ

- **Blue-Greenデプロイ**: ダウンタイムなし更新
- **ロールバック**: 30分以内に前バージョンへ復帰可能
- **データベースマイグレーション**: 
  - 前方互換性を保つスキーマ変更
  - マイグレーションスクリプトのバージョン管理

## 6. 保守性要件

### 6.1 コード品質

| 指標 | 目標値 | ツール |
|------|--------|--------|
| コードカバレッジ | 80%以上 | Jest/Pytest/JUnit |
| 循環的複雑度 | 10以下/関数 | ESLint/Pylint/SonarQube |
| コードレビュー | すべてのPRで実施 | GitHub PR Review |
| 静的解析 | ビルド時チェック | TypeScript/MyPy/SpotBugs |

### 6.2 ドキュメント

- **APIドキュメント**: OpenAPI 3.0、Swagger UI
- **コードコメント**: 複雑なロジックに説明コメント
- **README**: セットアップ手順、環境変数一覧
- **CHANGELOG**: バージョンごとの変更履歴

### 6.3 技術的負債管理

- **定期レビュー**: 四半期ごとに技術的負債を評価
- **依存関係更新**: 月次でライブラリのセキュリティアップデート
- **リファクタリング**: 複雑度が高い関数を優先的に改善

## 7. 互換性要件

### 7.1 OneRoster準拠

- **仕様バージョン**: OneRoster 1.2
- **IMS Certification**: 認証取得可能なレベルの実装
- **後方互換性**: OneRoster 1.1との相互運用性（オプション）

### 7.2 プラットフォーム

| 環境 | Node.js | Python | Java |
|------|---------|--------|------|
| **ランタイム** | 18+ | 3.10+ | 17+ |
| **データベース** | PostgreSQL 12+ | PostgreSQL 12+ | PostgreSQL 12+ |
| **OS** | Linux (Ubuntu 20.04+), macOS, Windows | Linux (Ubuntu 20.04+), macOS, Windows | Linux (Ubuntu 20.04+), macOS, Windows |
| **コンテナ** | Docker 20+ | Docker 20+ | Docker 20+ |

### 7.3 ブラウザ/クライアント

- **HTTPクライアント**: axios, httpx, RestTemplate等の標準ライブラリ
- **API管理ツール**: Postman、curl、HTTPie対応

## 8. 容量要件

### 8.1 データ容量

| データ種別 | 想定レコード数 | ストレージ見積もり |
|-----------|-------------|----------------|
| Categories | 100 | 10KB |
| LineItems | 10,000 | 5MB |
| Results | 1,000,000 | 500MB |
| **合計** | - | **約500MB** |

### 8.2 データ保持期間

- **アクティブデータ**: 現在の学年度
- **アーカイブデータ**: 過去5年間
- **削除ポリシー**: status='tobedeleted'は90日後に物理削除

## 9. 国際化要件

### 9.1 文字コード

- **UTF-8**: すべてのテキストデータ
- **多言語対応**: title、description等のフィールドで日本語、中国語等をサポート

### 9.2 日付・時刻

- **形式**: ISO 8601（YYYY-MM-DD、YYYY-MM-DDTHH:MM:SSZ）
- **タイムゾーン**: UTCで保存、表示時にローカルタイムゾーンへ変換

### 9.3 エラーメッセージ

- **デフォルト**: 英語
- **多言語化**: Accept-Languageヘッダーに基づく（将来拡張）

## 10. コンプライアンス要件

### 10.1 データプライバシー

- **GDPR準拠**: 個人データの削除権、データポータビリティ（将来対応）
- **FERPA準拠**: 学生記録の保護（米国教育機関向け）
- **匿名化**: テストデータは匿名化された架空データを使用

### 10.2 ライセンス

- **ソースコード**: MIT License
- **依存ライブラリ**: 商用利用可能なライセンス（MIT、Apache 2.0等）

## 11. テスト要件

### 11.1 テストカバレッジ

| テストタイプ | カバレッジ目標 | ツール |
|------------|-------------|--------|
| 単体テスト | 80% | Jest/Pytest/JUnit |
| 統合テスト | 主要フロー100% | Supertest/httpx/Spring Test |
| E2Eテスト | 全APIエンドポイント | Postman/Newman |
| 負荷テスト | - | Apache JMeter/k6 |

### 11.2 テスト環境

- **CI/CD**: GitHub Actions、GitLab CI
- **テストデータ**: 自動生成されたサンプルデータ
- **テストDB**: Docker Composeで立ち上げ

## 12. 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| セキュリティ担当 | | | |
| インフラ担当 | | | |
| 品質保証担当 | | | |

## 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|---------|
| 1.0.0 | 2025-10-30 | Initial | 初版作成 |
